# Slack Integration Setup Guide

This guide explains how to set up the Slack integration for JunoKit in production, allowing users to connect their own Slack workspaces.

## Overview

The Slack integration provides:
- **User-specific OAuth connections** - Each user connects their own Slack workspace
- **Secure token storage** - User tokens stored securely in DynamoDB
- **Scalable architecture** - Supports unlimited users and workspaces
- **Full messaging capabilities** - Send messages, list channels, and manage workspace data

## Architecture

```
Frontend (React) → API Gateway → Lambda Functions → DynamoDB
                                    ↓
                               AWS Secrets Manager
                                    ↓
                              Slack API (OAuth)
```

### Components Created

1. **Backend Lambda Functions:**
   - `slack-oauth.ts` - Handles OAuth flow (auth, callback, status, disconnect)
   - `slack-messaging.ts` - Handles messaging operations (send, channels, users)

2. **Frontend Components:**
   - `SlackIntegration.tsx` - Main integration UI component
   - `slack/callback/page.tsx` - OAuth callback handling page

3. **Infrastructure:**
   - API Gateway endpoints for Slack operations
   - DynamoDB integration data storage
   - Secrets Manager for Slack app credentials

## 1. Create Slack App

### Step 1: Create a New Slack App

1. Go to [Slack API Apps](https://api.slack.com/apps)
2. Click "Create New App" → "From scratch"
3. Choose an app name (e.g., "JunoKit Integration")
4. Select your development workspace (for testing)
5. Click "Create App"

### Step 2: Configure OAuth & Permissions

1. In your app settings, go to **"OAuth & Permissions"**
2. Add these **Redirect URLs**:
   ```
   https://app.junokit.com/integrations/slack/callback
   https://your-dev-domain.com/integrations/slack/callback
   ```

3. Add these **Bot Token Scopes**:
   ```
   channels:read        - View basic information about public channels
   channels:write       - Manage public channels  
   chat:write          - Send messages as the app
   users:read          - View people in the workspace
   teams:read          - View basic information about the workspace
   im:write            - Start direct messages with people
   groups:write        - Manage private channels
   ```

4. Add these **User Token Scopes**:
   ```
   identity.basic      - View basic profile info
   identity.email      - View email address
   ```

### Step 3: Get App Credentials

1. Note your **Client ID** and **Client Secret** from the "Basic Information" page
2. These will be added to AWS Secrets Manager

## 2. Update AWS Infrastructure

### Step 1: Update Secrets Manager

Add your Slack credentials to the existing `junokit-api-secrets`:

```bash
aws secretsmanager update-secret \
  --secret-id junokit-api-secrets \
  --secret-string '{
    "openRouterApiKey":"your-existing-key",
    "slackClientId":"your-slack-client-id",
    "slackClientSecret":"your-slack-client-secret",
    "githubToken":"",
    "googleClientId":"",
    "googleClientSecret":"",
    "autoGenerated":"PLACEHOLDER"
  }'
```

### Step 2: Deploy Infrastructure

The infrastructure changes are already included in the CDK stack. Deploy with:

```bash
cd infrastructure/aws-cdk
npm run deploy
```

This creates:
- Slack OAuth Lambda function (`junokit-slack-oauth`)
- Slack messaging Lambda function (`junokit-slack-messaging`)
- API Gateway endpoints:
  - `GET /integrations/slack/auth` - Initiate OAuth
  - `GET /integrations/slack/callback` - OAuth callback
  - `GET /integrations/slack/status` - Check connection status
  - `DELETE /integrations/slack/disconnect` - Disconnect workspace
  - `POST /integrations/slack/send` - Send messages
  - `GET /integrations/slack/channels` - List channels
  - `GET /integrations/slack/users` - List users

## 3. Database Schema

### User Profile Integration

User profiles in DynamoDB will include:

```json
{
  "userId": "user-123",
  "email": "user@example.com",
  "integrations": {
    "slack": {
      "connected": true,
      "teamId": "T1234567890",
      "teamName": "ACME Corp",
      "userName": "john.doe",
      "connectedAt": "2024-01-15T10:30:00Z"
    }
  }
}
```

### Detailed Integration Storage

Full integration details stored separately:

```json
{
  "userId": "user-123",
  "integrationId": "slack:T1234567890:user-123",
  "type": "slack",
  "accessToken": "xoxb-encrypted-token",
  "teamId": "T1234567890",
  "teamName": "ACME Corp",
  "userId_slack": "U0987654321",
  "userName": "john.doe",
  "scope": "channels:read,channels:write,chat:write...",
  "tokenType": "bot",
  "isEnterprise": false,
  "createdAt": "2024-01-15T10:30:00Z",
  "updatedAt": "2024-01-15T10:30:00Z",
  "isActive": true
}
```

## 4. API Endpoints

### Authentication Flow

```javascript
// 1. Initiate OAuth
GET /api/integrations/slack/auth
Headers: Authorization: Bearer <user-token>
Response: { authUrl: "https://slack.com/oauth/v2/authorize?...", state: "..." }

// 2. User redirected to Slack, then back to callback
GET /api/integrations/slack/callback?code=xxx&state=yyy
Response: { success: true, integration: {...} }

// 3. Check connection status
GET /api/integrations/slack/status
Headers: Authorization: Bearer <user-token>
Response: { connected: true, integration: {...} }
```

### Messaging Operations

```javascript
// Send message
POST /api/integrations/slack/send
Headers: Authorization: Bearer <user-token>
Body: {
  "channel": "C1234567890",
  "text": "Hello from JunoKit!",
  "blocks": [...],  // optional
  "thread_ts": "..." // optional
}

// List channels
GET /api/integrations/slack/channels
Headers: Authorization: Bearer <user-token>
Response: { channels: [...] }

// List users
GET /api/integrations/slack/users
Headers: Authorization: Bearer <user-token>
Response: { users: [...] }
```

## 5. Frontend Integration

### Add to Integrations Page

```tsx
import SlackIntegration from '@/components/integrations/SlackIntegration';

// In your integrations page
<SlackIntegration />
```

### OAuth Flow

1. User clicks "Connect to Slack"
2. Redirected to Slack OAuth (`/api/integrations/slack/auth`)
3. User authorizes on Slack
4. Redirected back to `/integrations/slack/callback`
5. Callback page processes the authorization
6. User redirected back to integrations page

## 6. Security Considerations

### Token Storage
- Access tokens encrypted at rest in DynamoDB
- Tokens scoped to specific user and workspace
- No shared tokens between users

### OAuth Security
- State parameter prevents CSRF attacks
- Short-lived authorization codes
- Secure redirect URI validation

### API Security
- All endpoints require user authentication
- User can only access their own integrations
- Rate limiting on Slack API calls

## 7. Scaling Considerations

### Multi-Workspace Support
- Users can connect multiple Slack workspaces
- Each workspace stored as separate integration
- UI shows all connected workspaces

### Rate Limiting
- Slack API has rate limits per workspace
- Implement exponential backoff
- Queue messages if needed

### Error Handling
- Token expiration handling
- Workspace deletion scenarios
- Network failure retries

## 8. Testing

### Development Testing

1. Create a test Slack workspace
2. Set up development Slack app
3. Use ngrok for local OAuth callback:
   ```bash
   ngrok http 3000
   # Add ngrok URL to Slack app redirects
   ```

### Production Testing

1. Test OAuth flow end-to-end
2. Verify message sending works
3. Test disconnection flow
4. Verify token security

## 9. Monitoring

### CloudWatch Metrics
- OAuth success/failure rates
- Message sending success rates
- API response times
- Error rates by endpoint

### Alerts
- High error rates
- OAuth failures
- Token refresh failures

## 10. Deployment Checklist

- [ ] Slack app created and configured
- [ ] OAuth redirect URLs set correctly
- [ ] Client ID and secret added to Secrets Manager
- [ ] Infrastructure deployed
- [ ] Frontend components deployed
- [ ] OAuth flow tested end-to-end
- [ ] Message sending tested
- [ ] Error handling verified
- [ ] Monitoring configured

## 11. Future Enhancements

- **Slack Events API** - Receive webhooks from Slack
- **Interactive Components** - Buttons and modals
- **Slash Commands** - Custom Slack commands
- **File Uploads** - Send files to Slack
- **Thread Management** - Better thread handling
- **Workspace Analytics** - Usage insights

## Troubleshooting

### Common Issues

1. **OAuth Redirect Mismatch**
   - Verify redirect URLs match exactly
   - Check URL encoding

2. **Token Issues**
   - Verify scopes are correct
   - Check token expiration

3. **API Errors**
   - Check CloudWatch logs
   - Verify Slack API rate limits

4. **Permission Errors**
   - Verify bot is added to channels
   - Check required scopes are granted 